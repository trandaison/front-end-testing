# Testable code
Äá»ƒ viáº¿t code dá»… kiá»ƒm thá»­ (testable), báº¡n cáº§n Ã¡p dá»¥ng má»™t sá»‘ nguyÃªn táº¯c vÃ  ká»¹ thuáº­t láº­p trÃ¬nh. DÆ°á»›i Ä‘Ã¢y lÃ  má»™t sá»‘ hÆ°á»›ng dáº«n vÃ  vÃ­ dá»¥ cá»¥ thá»ƒ:

## 1. Sá»­ dá»¥ng Dependency Injection (DI)

Khi má»™t class/module/function phá»¥ thuá»™c vÃ o má»™t class/module/function khÃ¡c (vd: API, DB, Logger,...) náº¿u khÃ´ng sá»­ dá»¥ng DI sáº½ ráº¥t khÃ³ Ä‘á»ƒ mock nhá»¯ng phá»¥ thuá»™c Ä‘Ã³ trong quÃ¡ trÃ¬nh kiá»ƒm thá»­.

VÃ­ dá»¥:

KhÃ´ng sá»­ dá»¥ng DI:
```ts
class UserService {
  async getUser(userId: number) {
    const response = await fetch(`https://api.example.com/users/${userId}`);
    return response.json();
  }
}
```

Sá»­ dá»¥ng DI:
```ts
class UserService {
  constructor(private apiClient: { get: (url: string) => Promise<any> }) {}

  async getUser(userId: number) {
    return this.apiClient.get(`/users/${userId}`);
  }
}
```

Unit test cho class `UserService`:

```ts
it("should return mock user", async () => {
  // Táº¡o mock API client
  const mockApiClient = {
    get: jest.fn().mockResolvedValue({ id: 1, name: "John Doe" }),
  };

  // Inject mock vÃ o UserService
  const userService = new UserService(mockApiClient);
  const user = await userService.getUser(1);

  // Kiá»ƒm tra káº¿t quáº£
  expect(user).toEqual({ id: 1, name: "John Doe" });
  expect(mockApiClient.get).toHaveBeenCalledWith("/users/1");
});
```
âœ” Dá»… dÃ ng test mÃ  khÃ´ng cáº§n káº¿t ná»‘i máº¡ng.

âœ” KhÃ´ng phá»¥ thuá»™c vÃ o API tháº­t, giÃºp test nhanh hÆ¡n.

âœ” CÃ³ thá»ƒ thay Ä‘á»•i API client dá»… dÃ ng mÃ  khÃ´ng cáº§n sá»­a toÃ n bá»™ code.


VÃ­ dá»¥ 2:

```js
function displayMessage(message) {
  document.getElementById('message').innerText = message;
}
```

Sá»­ dá»¥ng DI:

```js
function displayMessage(message, element) {
  element.innerText = message;
}

// Sá»­ dá»¥ng
displayMessage('Hello', document.getElementById('message'));
```

## 2. TÃ¡ch biá»‡t nghiá»‡p vá»¥ vÃ  logic I/O

HÃ£y tÃ¡ch biá»‡t logic xá»­ lÃ½ nghiá»‡p vá»¥ vÃ  logic I/O (Input/Output). Äiá»u nÃ y giÃºp báº¡n dá»… dÃ ng kiá»ƒm thá»­ logic nghiá»‡p vá»¥ mÃ  khÃ´ng cáº§n pháº£i quan tÃ¢m Ä‘áº¿n logic I/O.

VÃ­ dá»¥:

Code khÃ´ng tÃ¡ch biá»‡t:

HÃ m `readConfigFile` phá»¥ thuá»™c vÃ o module `fs` gÃ¢y khÃ³ khÄƒn khi test vÃ¬ pháº£i táº¡o file thá»±c táº¿.

```ts
const fs = require('fs');

function readConfigFile(filePath) {
  const data = fs.readFileSync(filePath, 'utf8');
  return JSON.parse(data);
}
```

Code dá»… kiá»ƒm thá»­ hÆ¡n:

```ts
function readConfigFile(fileService, filePath) {
  const data = fileService.readFileSync(filePath, 'utf8');
  return JSON.parse(data);
}

// Sá»­ dá»¥ng
import * as fs from 'fs';
readConfigFile(fs, './config.json');
```

Unit test cho hÃ m `readConfigFile`:

```ts
it("should return config object", () => {
  const mockFileService = {
    readFileSync: jest.fn().mockReturnValue('{"key": "value"}'),
  };

  const config = readConfigFile(mockFileService, './config.json');

  expect(config).toEqual({ key: "value" });
  expect(mockFileService.readFileSync).toHaveBeenCalledWith('./config.json', 'utf8');
});
```

VÃ­ dá»¥ 2: ÄÃ¢y lÃ  cÃ¡ch khÃ´ng tá»‘t, vÃ¬ nÃ³ káº¿t há»£p cáº£ gá»­i email (I/O) vÃ  xá»­ lÃ½ nghiá»‡p vá»¥.

```ts
import nodemailer from 'nodemailer';

export async function sendOrderConfirmation(email: string, orderTotal: number) {
  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: { user: 'your-email@gmail.com', pass: 'your-password' },
  });

  const discount = orderTotal > 500 ? 50 : 0; // ðŸŽ¯ Logic nghiá»‡p vá»¥ (khÃ¡ch VIP giáº£m 50K)

  await transporter.sendMail({
    from: 'your-email@gmail.com',
    to: email,
    subject: 'Order Confirmation',
    text: `Thank you! Your total is ${orderTotal - discount}.`,
  });

  return `Email sent to ${email}`;
}
```

**âš ï¸ Váº¥n Ä‘á»**
- Gá»­i email lÃ  thao tÃ¡c I/O, khÃ´ng dá»… kiá»ƒm thá»­.
- Logic giáº£m giÃ¡ bá»‹ trá»™n vá»›i viá»‡c gá»­i email â†’ khÃ³ tÃ¡i sá»­ dá»¥ng.
- Test sáº½ cháº¡y ráº¥t lÃ¢u & cÃ³ thá»ƒ bá»‹ lá»—i do máº¡ng khi cá»‘ gá»­i email tháº­t.

**âœ… CÃ¡ch tiáº¿p cáº­n dá»… test (TÃ¡ch I/O & Logic nghiá»‡p vá»¥)**

ChÃºng ta sáº½ tÃ¡ch biá»‡t pháº§n xá»­ lÃ½ nghiá»‡p vá»¥ & I/O (gá»­i email).

```ts
export function calculateDiscount(orderTotal: number): number {
  return orderTotal > 500 ? 50 : 0;
}

export function generateOrderMessage(orderTotal: number, discount: number): string {
  return `Thank you! Your total is ${orderTotal - discount}.`;
}

export async function sendEmail(emailService: { send: (to: string, subject: string, text: string) => Promise<void> }, email: string, message: string) {
  await emailService.send(email, 'Order Confirmation', message);
}
```

**ðŸ§ª Unit Test**

BÃ¢y giá», chÃºng ta cÃ³ thá»ƒ test logic tÃ­nh toÃ¡n & táº¡o message mÃ  khÃ´ng cáº§n email tháº­t:

```ts
import { calculateDiscount, generateOrderMessage, sendEmail } from './orderService';

describe('calculateDiscount', () => {
  it('should discount $50 for a $600 order', () => {
    expect(calculateDiscount(600)).toBe(50);
  });

  it('should not discount for a $500 order', () => {
    expect(calculateDiscount(500)).toBe(0);
  });
});

describe('generateOrderMessage', () => {
  it('should create message with discount', () => {
    expect(generateOrderMessage(600, 50)).toBe('Thank you! Your total is 550.');
  });

  it('should create message without discount', () => {
    expect(generateOrderMessage(500, 0)).toBe('Thank you! Your total is 500.');
  });
});

describe('sendEmail', () => {
  it('should call email service with correct parameters', async () => {
    const mockEmailService = {
      send: jest.fn().mockResolvedValue(undefined),
    };

    await sendEmail(mockEmailService, 'test@example.com', 'Order confirmed');

    expect(mockEmailService.send).toHaveBeenCalledWith(
      'test@example.com',
      'Order Confirmation',
      'Order confirmed'
    );
  });
});
```

**ðŸ”¥ Lá»£i Ã­ch**
âœ… Dá»… test â†’ Test logic tÃ­nh toÃ¡n mÃ  khÃ´ng cáº§n gá»­i email tháº­t.

âœ… CÃ³ thá»ƒ thay Ä‘á»•i email service (SendGrid, AWS SES, Mailgun,...) mÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n logic.

âœ… Nhanh & á»•n Ä‘á»‹nh â†’ KhÃ´ng phá»¥ thuá»™c vÃ o máº¡ng hay API bÃªn ngoÃ i.

## 3. Sá»­ dá»¥ng Pure Function

Pure function lÃ  hÃ m cÃ³ Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra xÃ¡c Ä‘á»‹nh, khÃ´ng phá»¥ thuá»™c vÃ o báº¥t ká»³ biáº¿n nÃ o bÃªn ngoÃ i hÃ m (no side effects).

VÃ­ dá»¥ 1:

Code khÃ´ng "pure"
```ts
const taxRate = 0.1;

function calcFinalPrice(price) {
  return price + (1 + taxRate);
}
```

Code "pure"
```ts
function calcFinalPrice(price, taxRate = 0.1) {
  return price + (1 + taxRate);
}
```

Viáº¿t Unit Test dá»… dÃ ng hÆ¡n

```ts
it("should calculate correct price with tax", () => {
  expect(calcFinalPrice(100, 0.1)).toBe(110);
  expect(calcFinalPrice(100, 0.08)).toBe(108);
});
```

VÃ­ dá»¥ 2:

Code khÃ´ng "pure" (thay Ä‘á»•i tráº¡ng thÃ¡i bÃªn ngoÃ i hÃ m)

```ts
let counter = 0;

function increment() {
  counter++;
}
```

**ðŸ”¥ Váº¥n Ä‘á»:**

âŒ HÃ m thay Ä‘á»•i giÃ¡ trá»‹ counter, lÃ m káº¿t quáº£ khÃ¡c nhau má»—i láº§n cháº¡y.

âŒ Test pháº£i reset counter trÆ°á»›c má»—i láº§n cháº¡y, ráº¥t dá»… gáº·p lá»—i.

Code "pure" (khÃ´ng thay Ä‘á»•i tráº¡ng thÃ¡i bÃªn ngoÃ i hÃ m)

```ts
function increment(counter) {
  return counter + 1;
}
```

Viáº¿t Unit Test dá»… dÃ ng hÆ¡n

```ts
test("increment should return incremented value", () => {
  expect(increment(0)).toBe(1);
  expect(increment(5)).toBe(6);
});
```

## 4. TÃ¡ch biá»‡t concerns

HÃ£y phÃ¢n chia logic thÃ nh cÃ¡c pháº§n nhá», má»—i pháº§n giáº£i quyáº¿t má»™t váº¥n Ä‘á» cá»¥ thá»ƒ (Single Responsibility Principle). Äiá»u nÃ y giÃºp báº¡n dá»… dÃ ng kiá»ƒm thá»­ tá»«ng pháº§n má»™t mÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c pháº§n khÃ¡c.

VÃ­ dá»¥:

Code khÃ´ng tÃ¡ch biá»‡t concerns:

```ts
function sendEmail(user) {
  const email = user.email;
  const message = `Hello, ${user.name}`;
  // Gá»­i email
}
```

Code tÃ¡ch biá»‡t concerns:

```ts
function getEmailContent(user) {
  return `Hello, ${user.name}`;
}

function sendEmail(email, message) {
  // Gá»­i email
}
```

VÃ­ dá»¥ 2:

Code khÃ´ng tÃ¡ch biá»‡t concerns:

```ts
function fetchDataAndDisplay() {
  const data = fetchData();
  displayData(data);
}
```

Code tÃ¡ch biá»‡t concerns:

```ts
function fetchData() {
  return fetch('https://api.example.com/data');
}

function displayData(data) {
  // Hiá»ƒn thá»‹ dá»¯ liá»‡u
}

// Sá»­ dá»¥ng
function main() {
  const data = fetchData();
  displayData(data);
}
```

VÃ­ dá»¥ 2:

Code viáº¿t gá»™p:

```ts
import fs from "fs";

function processConfig() {
  const data = fs.readFileSync("config.json", "utf-8");
  const config = JSON.parse(data);

  console.log(`App Name: ${config.appName}`);
}
```

Code tÃ¡ch biá»‡t concerns:

```ts
function readFile(fileReader: { readFileSync: (path: string, encoding: string) => string }, path: string) {
  return fileReader.readFileSync(path, "utf-8");
}

function parseConfig(jsonString: string) {
  return JSON.parse(jsonString);
}

function displayConfig(config: { appName: string }) {
  console.log(`App Name: ${config.appName}`);
}

// Sá»­ dá»¥ng
const fileReader = { readFileSync: fs.readFileSync };
const configData = readFile(fileReader, "config.json");
const config = parseConfig(configData);
displayConfig(config);
```
