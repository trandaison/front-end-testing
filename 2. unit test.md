# Unit test
## 2.1 Unit test lÃ  gÃ¬?
- Äá»‹nh nghÄ©a: Unit test lÃ  quÃ¡ trÃ¬nh kiá»ƒm thá»­ tá»«ng pháº§n nhá» nháº¥t cá»§a code, thÆ°á»ng lÃ  tá»«ng function hoáº·c class/component.
- Má»¥c Ä‘Ã­ch:
  - Äáº£m báº£o logic tá»«ng pháº§n nhá» nháº¥t cá»§a code hoáº¡t Ä‘á»™ng Ä‘Ãºng nhÆ° mong Ä‘á»£i.
  - PhÃ¡t hiá»‡n lá»—i sá»›m, giÃºp giáº£m thiá»ƒu lá»—i á»Ÿ cÃ¡c pháº§n khÃ¡c cá»§a há»‡ thá»‘ng.
  - TÄƒng cÆ°á»ng sá»± tá»± tin khi thay Ä‘á»•i code, giÃºp dá»… dÃ ng refactor code mÃ  khÃ´ng lo lá»—i.

## 2.2 Viáº¿t unit test hiá»‡u quáº£
- Cáº¥u trÃºc cá»§a 1 test case thÆ°á»ng tuÃ¢n thá»§ theo mÃ´ hÃ¬nh AAA:
  - **Arrange**: Chuáº©n bá»‹ dá»¯ liá»‡u cáº§n thiáº¿t cho test case.
  - **Act**: Thá»±c thi hÃ nh Ä‘á»™ng cáº§n kiá»ƒm thá»­.
  - **Assert**: So sÃ¡nh káº¿t quáº£ thá»±c táº¿ vá»›i káº¿t quáº£ mong Ä‘á»£i.
- Quy táº¯c **FIRST** trong Unit Test:
  - **F**ast: Test case pháº£i cháº¡y nhanh.
  - **I**ndependent: Test case pháº£i cháº¡y Ä‘á»™c láº­p.
  - **R**epeatable: Test case pháº£i cháº¡y giá»‘ng nhau má»—i láº§n cháº¡y.
  - **S**elf-validating: Test case pháº£i tá»± Ä‘Ã¡nh giÃ¡ káº¿t quáº£.
  - **T**imely: Viáº¿t Ä‘Ãºng thá»i Ä‘iá»ƒm, test case Ä‘Æ°á»£c viáº¿t ra trÆ°á»›c khi viáº¿t code.

**Vi pháº¡m nguyÃªn táº¯c Repeatable (CÃ³ thá»ƒ láº·p láº¡i)**

ğŸ”´ VÃ­ dá»¥ sai: Test nÃ y phá»¥ thuá»™c vÃ o thá»i gian thá»±c (`Date.now()`), má»—i láº§n cháº¡y cÃ³ thá»ƒ cho káº¿t quáº£ khÃ¡c nhau.

```ts
test("should generate a unique order ID", () => {
  const orderId1 = `ORDER-${Date.now()}`;
  const orderId2 = `ORDER-${Date.now()}`;
  expect(orderId1).toBe(orderId2); // Lá»—i vÃ¬ thá»i gian thay Ä‘á»•i
});
```
âœ… CÃ¡ch viáº¿t Ä‘Ãºng: Mock Date.now() Ä‘á»ƒ Ä‘áº£m báº£o test cháº¡y láº¡i váº«n cho káº¿t quáº£ nhÆ° nhau.

```ts
test("should generate a unique order ID", () => {
  const mockDateNow = jest.spyOn(Date, "now").mockReturnValue(0);
  const orderId1 = `ORDER-${Date.now()}`;
  const orderId2 = `ORDER-${Date.now()}`;
  expect(orderId1).toBe(orderId2); // Pass vÃ¬ Date.now() tráº£ vá» giÃ¡ trá»‹ cá»‘ Ä‘á»‹nh
  mockDateNow.mockRestore();
});
```

**Vi pháº¡m nguyÃªn táº¯c Self-validating (Tá»± xÃ¡c thá»±c)**

ğŸ”´ VÃ­ dá»¥ sai: Test nÃ y khÃ´ng cÃ³ báº¥t ká»³ expect() nÃ o Ä‘á»ƒ xÃ¡c thá»±c káº¿t quáº£, chá»‰ log ra console.

```ts
test("should return correct user data", async () => {
  const user = await fetchUser(1);
  console.log(user); // KhÃ´ng cÃ³ kiá»ƒm tra káº¿t quáº£
});
```
âœ… CÃ¡ch viáº¿t Ä‘Ãºng: Sá»­ dá»¥ng expect() Ä‘á»ƒ kiá»ƒm tra káº¿t quáº£ tráº£ vá».

```ts
test("should return correct user data", async () => {
  const user = await fetchUser(1);
  expect(user).toEqual({ id: 1, name: "Alice" });
});
```
## 2.3. Cáº¥u trÃºc má»™t file test
- ThÆ° má»¥c test thÆ°á»ng Ä‘Æ°á»£c Ä‘áº·t tÃªn theo cáº¥u trÃºc `__tests__` hoáº·c `test`.
- TÃªn file test thÆ°á»ng Ä‘Æ°á»£c Ä‘áº·t theo cáº¥u trÃºc `<tÃªn file>.test.<Ä‘uÃ´i file>`.
- Cáº¥u trÃºc má»™t file test thÆ°á»ng bao gá»“m:
  - Import cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t.
  - Import file cáº§n kiá»ƒm thá»­.
  - Viáº¿t test case sá»­ dá»¥ng hÃ m `test()` hoáº·c `it()`.

```ts
// sum.test.ts
import { sum } from "../sum"; // Import file cáº§n kiá»ƒm thá»­

describe("sum function", () => {
  test("returns correct sum for positive numbers", () => {
    expect(sum(2, 3)).toBe(5);
  });

  test("returns correct sum for negative numbers", () => {
    expect(sum(-2, -3)).toBe(-5);
  });

  test("returns correct sum for mixed numbers", () => {
    expect(sum(-2, 3)).toBe(1);
  });
});
```

## 2.3.1. CÃ¡c thÃ nh pháº§n vÃ  cÃº phÃ¡p quan trá»ng

1. **describe()**: DÃ¹ng Ä‘á»ƒ nhÃ³m cÃ¡c test case liÃªn quan láº¡i vá»›i nhau.

```ts
describe("sum function", () => {
  // CÃ¡c test case liÃªn quan Ä‘áº¿n hÃ m sum
});
```

- `describe()` cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ mÃ´ táº£ cho má»™t hÃ m, má»™t module, má»™t component, má»™t API, má»™t class, má»™t nhÃ³m test case, má»™t trÆ°á»ng há»£p test. `describe()` cÃ³ thá»ƒ chá»©a nhiá»u `describe()` khÃ¡c bÃªn trong.
- Sá»­ dá»¥ng prefix `.` Ä‘á»ƒ mÃ´ táº£ cÃ¡c instance method cá»§a má»™t class hoáº·c property cá»§a má»™t object. Sá»­ dá»¥ng prefix `#` Ä‘á»ƒ mÃ´ táº£ cÃ¡c static method cá»§a má»™t class hoáº·c static property cá»§a má»™t object.

```ts
describe("Number", () => {
  describe(".toString()", () => {
    // CÃ¡c test case liÃªn quan Ä‘áº¿n hÃ m Number.toString()
  });

  describe(".toFixed()", () => {
    // CÃ¡c test case liÃªn quan Ä‘áº¿n hÃ m Number.toFixed()
  });

  describe("#parseInt", () => {
    // CÃ¡c test case liÃªn quan Ä‘áº¿n hÃ m Number.parseInt()
  });

  describe("#isNaN", () => {
    // CÃ¡c test case liÃªn quan Ä‘áº¿n hÃ m Number.isNaN()
  });
});
```

2. **test() hoáº·c it()**: DÃ¹ng Ä‘á»ƒ viáº¿t test case.

`it(description, callback)` hoáº·c `test(description, callback)` Ä‘á»u Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ define má»™t test case cá»¥ thá»ƒ trong má»™t describe block.

```ts
describe("Number", () => {
  describe(".toString()", () => {
    it("should return a string", () => {
      // Test case
    });
  });
});
```

`description` lÃ  mÃ´ táº£ ngáº¯n gá»n vá» test case, nÃ³ nÃªn Ä‘Æ°á»£c mÃ´ táº£ ngáº¯n gá»n, theo ngÃ´n ngá»¯ tá»± nhiÃªn:

âŒ Bad:
```ts
it('calls handleSubmit and sets state to loading')
it('handles input')
it('success')
it('displays a loading indicator when the form is submitted')
```

âœ… Good:
```ts
it('should submit the form and set the loading state') // MÃ´ táº£ vá» hÃ nh vi mong Ä‘á»£i thay vÃ¬ mÃ´ táº£ chi tiáº¿t cÃ¡ch code hoáº¡t Ä‘á»™ng
it('should display the user input')
it('should display a success message')
// DÃ¹ng describe() Ä‘á»ƒ mÃ´ táº£ trÆ°Æ¡ng há»£p test, it Ä‘á»ƒ mÃ´ táº£ test case
discribe('when the form is submitted', () => {
  it('should display a loading indicator')
})
```

3. **expect()**: DÃ¹ng Ä‘á»ƒ so sÃ¡nh káº¿t quáº£ thá»±c táº¿ vá»›i káº¿t quáº£ mong Ä‘á»£i.

VÃ­ dá»¥ má»™t sá»‘ matcher phá»• biáº¿n:

```ts
expect(1 + 4).toBe(5); // So sÃ¡nh báº±ng
expect({ id: 1 }).toEqual({ id: 1 }); // So sÃ¡nh deep equal
expect([1, 2, 3]).toContain(2); // Kiá»ƒm tra pháº§n tá»­ cÃ³ tá»“n táº¡i trong máº£ng
expect("hello").toMatch(/hello/); // Kiá»ƒm tra chuá»—i cÃ³ match vá»›i regex
expect(() => { throw new Error("error") }).toThrow("error"); // Kiá»ƒm tra hÃ m cÃ³ throw error
```

4. **beforeEach()** vÃ  **afterEach()**: DÃ¹ng Ä‘á»ƒ cháº¡y má»™t hÃ m trÆ°á»›c má»—i test case hoáº·c sau má»—i test case.

```ts
let users = [];

// Reset users trÆ°á»›c má»—i test case
beforeEach(() => {
  users = [{ id: 1, name: "Alice" }, { id: 2, name: "Bob" }];
});

it("should be able to add a new user", () => {
  users.push({ id: 3, name: "Charlie" });
  expect(users).toHaveLength(3);
});

it("should be able to remove a user", () => {
  users.pop();
  expect(users).toHaveLength(1);
});
```

5. **beforeAll()** vÃ  **afterAll()**: DÃ¹ng Ä‘á»ƒ cháº¡y má»™t hÃ m trÆ°á»›c táº¥t cáº£ cÃ¡c test case hoáº·c sau táº¥t cáº£ cÃ¡c test case.

6. Mocking
- Mocking lÃ  ká»¹ thuáº­t giáº£ láº­p má»™t hÃ m hoáº·c module khÃ¡c Ä‘á»ƒ kiá»ƒm thá»­ mÃ  khÃ´ng cáº§n phá»¥ thuá»™c vÃ o hÃ m hoáº·c module tháº­t.

VÃ­ dá»¥ Ã¡p dá»¥ng mock Ä‘á»ƒ test function sau:

```ts
function handlePageLoad(productId) {
  return fetchProduct(productId)
    .then((data) => data.product)
    .catch(redirectToPageNotFound);
}
```

Váº¥n Ä‘á» khi test function trÃªn lÃ  phá»¥ thuá»™c vÃ o hÃ m `fetchProduct` vÃ  `redirectToPageNotFound`, Ä‘á»ƒ test Ä‘á»§ cÃ¡c trÆ°á»ng há»£p cáº§n pháº£i mock 2 hÃ m nÃ y.

```ts
import { handlePageLoad } from "~/pages/Product.vue";

describe("ProductPage", () => {
  describe("when product is loaded", () => {
    it("should return product data", async () => {
      const product = { id: 1, name: "Product 1" };
      jest.spyOn(ProductPage.methods, "fetchProduct").mockResolvedValue({ product });

      const data = await ProductPage.handlePageLoad(1);

      expect(data).toEqual(product);
    });
  });

  describe("when product is not found", () => {
    it("should redirect to 404 page", async () => {
      jest.spyOn(ProductPage.methods, "fetchProduct").mockRejectedValue(new Error("Not found"));
      const redirectToPageNotFound = jest.fn();

      await ProductPage.handlePageLoad(1);

      expect(redirectToPageNotFound).toHaveBeenCalled();
    });
  });
});
```
Giáº£i thÃ­ch:
- Sá»­ dá»¥ng `jest.spyOn()` Ä‘á»ƒ mock hÃ m `fetchProduct` vÃ  `redirectToPageNotFound`.
- Sá»­ dá»¥ng `mockResolvedValue()` Ä‘á»ƒ giáº£ láº­p hÃ m tráº£ vá» giÃ¡ trá»‹ mong muá»‘n.
- Sá»­ dá»¥ng `mockRejectedValue()` Ä‘á»ƒ giáº£ láº­p hÃ m tráº£ vá» lá»—i.
- Sá»­ dá»¥ng `jest.fn()` Ä‘á»ƒ táº¡o má»™t mock function.

**ğŸ¯ Khi nÃ o dÃ¹ng `jest.fn()` vÃ  `jest.spyOn()`?**
- DÃ¹ng jest.fn() khi muá»‘n táº¡o má»™t hÃ m giáº£ láº­p tá»« Ä‘áº§u (thÆ°á»ng dÃ¹ng Ä‘á»ƒ mock API, database, hoáº·c callback).
- DÃ¹ng jest.spyOn() khi muá»‘n theo dÃµi má»™t hÃ m cÃ³ sáºµn mÃ  khÃ´ng cáº§n thay Ä‘á»•i hoÃ n toÃ n logic (thÆ°á»ng dÃ¹ng Ä‘á»ƒ kiá»ƒm tra console, gá»i API, gá»i method cá»§a class...).

## 2.4. Testing components

### 2.4.1. React component
- Sá»­ dá»¥ng `@testing-library/react` Ä‘á»ƒ test React component.

```ts
import {render, screen} from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import '@testing-library/jest-dom'
import Fetch from './fetch'

test('loads and displays greeting', async () => {
  // ARRANGE
  render(<Fetch url="/greeting" />)

  // ACT
  await userEvent.click(screen.getByText('Load Greeting'))
  await screen.findByRole('heading')

  // ASSERT
  expect(screen.getByRole('heading')).toHaveTextContent('hello there')
  expect(screen.getByRole('button')).toBeDisabled()
})
```

Cheatsheet: https://testing-library.com/docs/react-testing-library/cheatsheet

### 2.4.2. Vue component

- Sá»­ dá»¥ng `@testing-library/vue` Ä‘á»ƒ test Vue component.

VÃ­ dá»¥ test component Counter.vue:

```vue
<template>
  <div>
    <p>Times clicked: {{ count }}</p>
    <button @click="increment">increment</button>
  </div>
</template>

<script>
  export default {
    data: () => ({
      count: 0,
    }),

    methods: {
      increment() {
        this.count++
      },
    },
  }
</script>
```

```ts
import {render, fireEvent, screen} from '@testing-library/vue'
import Component from './Component.vue'

test('increments value on click', async () => {
  render(Component)

  // screen has all queries that you can use in your tests.
  // getByText returns the first matching node for the provided text, and
  // throws an error if no elements match or if more than one match is found.
  screen.getByText('Times clicked: 0')

  const button = screen.getByText('increment')

  // Dispatch a native click event to our button element.
  await fireEvent.click(button)
  await fireEvent.click(button)

  screen.getByText('Times clicked: 2')
})
```

VÃ­ dá»¥ test v-model

```vue
<template>
  <div>
    <p>Hi, my name is {{ user }}</p>

    <label for="username">Username:</label>
    <input v-model="user" id="username" name="username" />
  </div>
</template>

<script>
  export default {
    data: () => ({
      user: 'Alice',
    }),
  }
</script>
```

```ts
import {render, fireEvent, screen} from '@testing-library/vue'
import Component from './Component.vue'

test('properly handles v-model', async () => {
  render(Component)

  // Asserts initial state.
  screen.getByText('Hi, my name is Alice')

  // Get the input DOM node by querying the associated label.
  const usernameInput = screen.getByLabelText(/username/i)

  // Updates the <input> value and triggers an `input` event.
  // fireEvent.input() would make the test fail.
  await fireEvent.update(usernameInput, 'Bob')

  screen.getByText('Hi, my name is Bob')
})
```

Cheatsheet: https://testing-library.com/docs/vue-testing-library/cheatsheet

### 2.4.3. Best practices

- **Render the component**: Sá»­ dá»¥ng `render()` Ä‘á»ƒ render component cáº§n test. Äá»‘i vá»›i Vue component, khÃ´ng nÃªn sá»­ dá»¥ng `shallowMount`.
- ThÃªm thuá»™c tÃ­nh `data-testid` vÃ o cÃ¡c element cáº§n test Ä‘á»ƒ dá»… dÃ ng query.

## 2.5. Snapshot testing

## 2.6. Code coverage
### 2.6.1. ğŸ“Œ Code Coverage lÃ  gÃ¬?
Code Coverage (Äá»™ phá»§ mÃ£) lÃ  thÆ°á»›c Ä‘o cho biáº¿t bao nhiÃªu pháº§n trÄƒm code cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm tra báº±ng test. Má»¥c tiÃªu cá»§a code coverage lÃ  Ä‘áº£m báº£o ráº±ng táº¥t cáº£ cÃ¡c nhÃ¡nh logic quan trá»ng trong code Ä‘á»u Ä‘Æ°á»£c kiá»ƒm thá»­.

### 2.6.2. ğŸ“Š CÃ¡c loáº¡i Code Coverage phá»• biáº¿n
1. **Statement coverage**: Äo lÆ°á»ng sá»‘ lÆ°á»£ng cÃ¢u lá»‡nh trong code Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi.
2. **Branch coverage**: Äo lÆ°á»ng sá»‘ lÆ°á»£ng nhÃ¡nh logic trong code Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi.
3. **Function coverage**: Äo lÆ°á»ng sá»‘ lÆ°á»£ng function trong code Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi.
4. **Line coverage**: Äo lÆ°á»ng sá»‘ lÆ°á»£ng dÃ²ng code Ä‘Ã£ Ä‘Æ°á»£c thá»±c thi.

### 2.6.3. VÃ­ dá»¥ minh há»a

![alt text](./img/image.png)

![alt text](./img/image-1.png)

![alt text](./img/image-2.png)

### 2.6.4. ğŸ¯ Nhá»¯ng lÆ°u Ã½ quan trá»ng vá» Code Coverage
- âœ… Code Coverage cao khÃ´ng Ä‘áº£m báº£o cháº¥t lÆ°á»£ng test tá»‘t. Test cáº§n kiá»ƒm thá»­ cáº£ logic, edge case, hÃ nh vi ngÆ°á»i dÃ¹ng.
- âœ… Má»©c coverage khuyáº¿n nghá»‹:
  - 80% trá»Ÿ lÃªn cho unit test.
  - 60-70% cho integration test.
  - E2E test khÃ´ng cáº§n quÃ¡ cao, quan trá»ng lÃ  mÃ´ phá»ng Ä‘Ãºng hÃ nh vi ngÆ°á»i dÃ¹ng.
- âœ… KhÃ´ng nÃªn cháº¡y theo 100% coverage â†’ Quan trá»ng nháº¥t lÃ  kiá»ƒm thá»­ Ä‘Ãºng logic, chá»© khÃ´ng pháº£i chá»‰ Ä‘áº£m báº£o sá»‘ liá»‡u.
